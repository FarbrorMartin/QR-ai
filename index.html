<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diamantjakten</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      /* Assuming a dark background */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      /* Evenly space out header, frame, and button */
      height: 100%;
      width: 100%;
      font-family: 'Arial', sans-serif;
      background-image: url('jungle_background2.jpg');
      background-size: cover;
      background-repeat: no-repeat;

      /* Space around the edges */
    }

    .header {
      text-shadow: 0px 0px 6px rgb(255 144 0);
      background-image: url(banner2.png);
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      text-align: center;
      color: #420022;
      min-width: 80vw;
      min-height: 10vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10vw;
      margin-top: 10px;
      outline: 4px solid #1e1111;
      border-radius: 8px;
    }

    .overlay-text {
      font-size: 10vw;
      color: #efff16;
      position: fixed;
      top: 20%;
      text-shadow: 0 0 2vw white;
    }

    .modal {
      position: fixed;
      /* Stay in place */
      z-index: 1;
      /* Sit on top */
      left: 0;
      top: 0;
      width: 100%;
      /* Full width */
      height: 100%;
      /* Full height */
      overflow: auto;
      /* Enable scroll if needed */
      background-color: #000000;
      /* Fallback color */

    }

    .main-container {
      width: 80%;
      height: 80%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
    }

    /* Modal Content/Box */
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      /* 15% from the top and centered */
      padding-top: 20px;
      padding-bottom: 20px;
      border-radius: 10px;
      border: 6px dashed #a72009;
      width: 80%;
      height: 80%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0px 0px 10px #000000b3;
      animation-name: modalopen;
      animation-duration: 1s
    }

    /* Add Animation */
    @keyframes modalopen {
      from {
        opacity: 0
      }

      to {
        opacity: 1
      }
    }



    .modal-content p {
      text-align: center;
      padding-top: 0px;
      padding-left: 20px;
      padding-right: 20px;
      margin-top: 5px;
      margin-bottom: 5px;
    }

    .modal-content p.large {
      /* height: 15%; */
      font-size: 8vmin;
    }

    .modal-content p.small {
      /* height: 15%; */
      font-size: 6vmin;
    }

    .modal-content-center-element {
      height: 50%;
      padding-top: 2vh;
    }

    .modal-content button {
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 1vh;
      margin-bottom: 1vh;
    }

    .modal-content button:hover {
      cursor: pointer
    }

    .modal-button {
      width: 60%;
      height: 15%;
      font-size: 12vmin;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .timed-popup {
      position: fixed;
      top: 20%; /* Adjust as needed for top half positioning */
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 2em;
      z-index: 1000; /* Ensures it floats above other elements */
    }

    .frame {
      background-color: #301708;
      border-radius: 15px;
      border: 10px solid #8B4513;
      padding: 1vh;
      box-shadow: 0 0 10px #000;
      width: 80vw;
      height: 60vh;
      margin: 10px 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      max-width: 300px;
    }

    .game-container {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      /* Distribute space among children */
      height: 100%;
      /* Fill the height of the frame */
    }

    .diamond-container {
      width: 25vw;
      /* Decrease the width of the top gem */

      margin: 0 auto;
      display: block;
      height: 20%;
      width: auto;
    }

    .top-gem {
      width: 25%;
      margin: auto;
      display: block;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-gap: 1vw;
      padding: 2vh;
      flex-grow: 1;
      max-height: 50%;
    }

    .gem-slot {
      border-radius: 55%;
      background-color: #333;
      box-shadow: inset 0 0 8px #000;
      aspect-ratio: 1;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;

    }

    .bandit-row {
      display: flex;
      justify-content: space-around;
      margin-top: 2vh;
      max-height: 15%;
      width: 60%;
      margin: auto;
    }


    .bandit-marker {
      border-radius: 55%;
      /* Responsive bandit size based on viewport width */
      max-width: 30%;
      /* Maximum width of bandit images */
    }

    .score {
      text-align: center;
      color: #ffd700;
      font-size: 5vh;
      margin: 1vh 0;
      max-height: 15%;
    }

    .scan-button {
      background: url('qr-code-scan-icon.png') no-repeat center center;
      background-size: contain;
      width: 20vw;
      /* Decrease the width of the scan button */
      height: 20vw;
      /* Adjust the height to maintain the aspect ratio */
      max-width: 150px;
      /* Decrease the maximum size */
      max-height: 150px;
      border: none;

      margin-bottom: auto;
    }

    .scan-button.active {
      background: url('qr-code-scan-icon-active.png') no-repeat center center;
      background-size: contain;
    }


    .video-container-flex {
      width: 100%;
      /* Fill the parent container */
      height: 100%;
      /* Fill the parent container */
      background: black;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
    }

    .video-feed {
      width: 100%;
      height: 100%;
      object-fit: cover;
      /* This will cover the entire parent area */
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <div class="main-container">
    <div class="header">Diamantjakten</div>
    <div id="waiting-for-game-text" class="overlay-text hidden">Väntar på ledaren...</div>
    <div class="frame">
      <div id="video-container" class="video-container-flex hidden">
        <video id="qr-video" class="video-feed"></video>
      </div>
      <div id="game-container" class="game-container">
        <div class="diamond-container">
          <img src="diamond.png" class="top-gem">
        </div>
        <div class="grid">
          <!-- 5x4 grid of random gems -->
          <div class="gem-slot"></div> <!-- Empty slot -->
          <div class="gem-slot"></div> <!-- Empty slot -->
          <div class="gem-slot"></div> <!-- Empty slot -->
          <div class="gem-slot"></div> <!-- Empty slot -->
          <div class="gem-slot"></div> <!-- Empty slot -->
          <div class="gem-slot"></div> <!-- Empty slot -->
          <div class="gem-slot"></div> <!-- Empty slot -->
          <div class="gem-slot"></div> <!-- Empty slot -->
          <div class="gem-slot"></div> <!-- Empty slot -->
          <div class="gem-slot"></div> <!-- Empty slot -->
          <div class="gem-slot"></div> <!-- Empty slot -->
          <div class="gem-slot"></div> <!-- Empty slot -->
          <div class="gem-slot"></div> <!-- Empty slot -->
          <div class="gem-slot"></div> <!-- Empty slot -->
          <div class="gem-slot"></div> <!-- Empty slot -->
          <div class="gem-slot"></div> <!-- Empty slot -->
          <div class="gem-slot"></div> <!-- Empty slot -->
          <div class="gem-slot"></div> <!-- Empty slot -->
          <div class="gem-slot"></div> <!-- Empty slot -->
          <div class="gem-slot"></div> <!-- Empty slot -->

          <!-- Repeat for each gem -->
        </div>
        <div class="bandit-row">

        </div>
        <div id="score" class="score">Score: 0</div>
      </div>
    </div>

    <button class="scan-button"></button>
  </div>
</body>

</html>
<script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-database.js"></script>
<script src="qrcode.min.js"></script>
<script type="module">
  "use strict";
  import QrScanner from "./qrscan/qr-scanner.min.js";
  // try{

  let testMode = false;
  // Constants
  const GAME_NOT_STARTED = 0;
  const GAME_INITIALIZED = 1;
  const GAME_IN_PROGRESS = 2;
  const GAME_FINISHED = 3;
  const scanHideShowDelay = 500;
  let playerFinished = false;

  // Sound initialization
  const correctSound = new Audio("Stinger15.mp3");
  const errorSound = new Audio("wrong.mp3");
  const banditEncounterSound = new Audio("maleb_laugh.mp3");
  const banditCaughtSound = new Audio("evil_laughter.mp3");
  const banditEscapeSound = new Audio("event_15.mp3");
  const coinsSound = new Audio("Coins_Drop_Carpet_05.mp3");
  const diamondSound = new Audio("Stinger_1.mp3");
  const gemSound = new Audio("Glass_2.mp3");
  const whistleSound = new Audio("whistle2.mp3");
  const finishGameSound = new Audio("Stinger_13.mp3");
  const clickSound = new Audio("clicky_button_low.mp3");

  // Images
  const banditImage = "bandit_100x100.png";

  // treasures
  const encounters = ["bandit", "bandit", "bandit", "diamond", "ruby", "ruby", "sapphire", "sapphire", "emerald", "emerald", "coins", "coins", "coins", "coins", "coins", "coins", "coins", "coins", "coins", "coins"];
  const treasures = {
    diamond: {
      value: 100,
      image: "diamond.png",
      name: "diamanten",
      sound: diamondSound
    },
    ruby: {
      value: 50,
      image: "ruby.png",
      name: "en rubin",
      sound: gemSound,
    },
    emerald: {
      value: 40,
      image: "emerald.png",
      name: "en smaragd",
      sound: gemSound,
    },
    sapphire: {
      value: 30,
      image: "sapphire.png",
      name: "en safir",
      sound: gemSound,
    },
    topaz: {
      value: 20,
      image: "topas.png",
      name: "en topas",
      sound: gemSound,
    },
    coins: {
      value: 5,
      image: "coins.jfif",
      name: "en hög guldmynt",
      sound: coinsSound,
    }
  };

  let foundTreasures = [];

  // Global Variables
  let gameState = GAME_NOT_STARTED;
  let money = 0;
  let foundDiamond = false;
  let banditMarkers = 0;
  let shuffledLocations = [];
  let visitedLocations = [];
  let finishTime = 0;
  let startTime = new Date().getTime();
  let isProcessingScanResult = false;

  let currentGameId = null;
  let playerId = 'player_' + Math.random().toString(36).substr(2, 9);


  let state = {
    gameState: GAME_NOT_STARTED,
    money: 0,
    foundDiamond: false,
    shuffledLocations: [],
    visitedLocations: [],
    startTime: new Date().getTime()
  };

  // HTML Elements
  const video = document.querySelector("#qr-video");
  const videoContainer = document.querySelector("#video-container");
  const scanButton = document.querySelector(".scan-button");
  const colorBlock = document.querySelector("#color-block");
  const banditContainer = document.querySelector(".bandit-row");
  const qrcodeContainer = document.querySelector("#qrcode-container");
  const gameContainer = document.querySelector("#game-container");
  const treasureGrid = document.querySelector(".grid");
  const gemSlots = document.querySelectorAll(".gem-slot");
  const overlayText = document.querySelector("#waiting-for-game-text");



  // QR Scanner
  const scanner = new QrScanner(video, result => handleScanResult(result), {
    onDecodeError: error => console.log(error),
    highlightScanRegion: false,
    highlightCodeOutline: true,
  });
  scanner.setCamera("environment");

  // Event Listeners
  scanButton.addEventListener("click", toggleScanner);

  // Functions
  function handleScanResult(result) {
    if (!isProcessingScanResult) {
      isProcessingScanResult = true;
      const url = new URL(result.data);
      scanQRCode(url.searchParams);
      scanner.stop();
    }
  }

  function scanQRCode(urlParams) {
    console.log("IS SCANNING:" + isProcessingScanResult.toString());
    scanner.stop();
    setTimeout(() => {
      setScannerState(false);
      let scannedGameId = urlParams.get("gameid");
      const gameSeed = urlParams.get("gameseed");
      const location = urlParams.get("location");
      if (gameSeed !== null) handleSeedScanned(scannedGameId, gameSeed);
      else if (location === null || location === "start") handleStartScanned();
      else if (visitedLocations.includes(location)) errorSound.play();
      else showModal({
        message: "Klicka för söka igenom platsen!",
        callback: () => handleEncounterBing(location)
      });
      isProcessingScanResult = false;
    }, scanHideShowDelay);
  }



  function startNewGame() {

    resetGame();
    
    gameState = GAME_INITIALIZED;

    if (testMode == true){
      trace("Testmode");
      shuffledLocations = [];
      for (var i in encounters) {
        shuffledLocations.push(i);
      }
    }

    registerNewGame();

    var qrCodeContainer = document.createElement("div");
    renderQRCodeGameSeed(qrCodeContainer, JSON.stringify(shuffledLocations), "#000000");

    showModal({
      message: "Nytt spel!",
      callback: () => sendGameStartedEvent(),
      element: qrCodeContainer,
      secondMessage: "Andra kan skanna koden här för att joina ditt spel. Tryck OK för att starta spelet!"
    });



  }



  function sendGameStartedEvent(){
    var eventsRef = database.ref('games/' + currentGameId + '/events');
    eventsRef.push({
      action: 'gameStarted',
      gameId: currentGameId,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });
    
    
  }



  function showModal(options) {
    var modal = document.createElement("div");
    modal.classList.add("modal");

    var modalContent = document.createElement("div");
    modalContent.classList.add("modal-content");

    var messageElement = document.createElement("p");
    messageElement.textContent = options.message;
    messageElement.classList.add("large");
    modalContent.appendChild(messageElement);

    if (options.secondMessage) {
      var secondMessageElement = document.createElement("p");
      secondMessageElement.textContent = options.secondMessage;
      secondMessageElement.classList.add("small");
      modalContent.appendChild(secondMessageElement);
    }

    if (options.element) {
      let el = options.element;
      el.classList.add("modal-content-center-element");
      modalContent.appendChild(el);
    }

    var okButton = document.createElement("button");
    okButton.textContent = options.buttonText ?? "OK";
    okButton.classList.add("modal-button");

    okButton.addEventListener("click", function () {
      modal.remove();
      if (options.callback) {
        options.callback();
      }
    });

    modalContent.appendChild(okButton);
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
  }

  function updateScore() {
    var moneyElement = document.querySelector("#score");
    moneyElement.textContent = money.toString() + " kr";

    var foundDiamondElement = document.querySelector("#found-diamond");
    // if (foundDiamond) {
    //   foundDiamondElement.textContent = "Du hittade diamanten!";
    // }
    // else {
    //   foundDiamondElement.textContent = "";
    // }

    // var finishTimeElement = document.querySelector("#finish-time");
    // if (gameState == GAME_FINISHED) {
    //   var timeInSeconds = finishTime / 1000;
    //   var seconds = Math.floor(timeInSeconds % 60);
    //   var minutes = Math.floor(timeInSeconds / 60);
    //   finishTimeElement.textContent = "TID: " + minutes + "m " + seconds + "s";
    // }
    // else {
    //   finishTimeElement.textContent = "";
    // }

    // banditContainer.textContent = "";
    // for (var i = 0; i < banditMarkers; i++) {
    //   var banditImage = document.createElement("img");
    //   banditImage.src = "bandit.jfif";
    //   banditImage.style.width = "50px";
    //   banditImage.style.height = "50px";
    //   banditImage.style.marginRight = "10px";
    //   banditContainer.appendChild(banditImage);
    // }
  }
  // Bing Chat
  function saveStateObject() {
    localStorage.setItem("state", JSON.stringify(state));
  }

  function loadStateObject() {
    var savedState = localStorage.getItem("state");
    if (savedState) {
      state = JSON.parse(savedState);
      return true;
    }
    else {
      resetState();
      return false;
    }
  }

  function resetStateObject() {
    Object.assign(state, {
      gameState: GAME_NOT_STARTED,
      money: 0,
      foundDiamond: false,
      shuffledLocations: [],
      visitedLocations: [],
      startTime: new Date().getTime(),
      banditMarkers: 0
    });
  }


  function loadState() {
    var parsedGameState = parseInt(localStorage.getItem("gameState"));
    if (isNaN(parsedGameState)) {
      resetState();
      return false;
    }
    else {
      gameState = parsedGameState;
    }
    playerFinished = JSON.parse(localStorage.getItem("playerFinished"));
    currentGameId = JSON.parse(localStorage.getItem("gameId"));
    shuffledLocations = JSON.parse(localStorage.getItem("shuffledLocations"));
    visitedLocations = JSON.parse(localStorage.getItem("visitedLocations")) ?? [];
    money = parseInt(localStorage.getItem("money")) ?? 0;
    foundDiamond = localStorage.getItem("foundDiamond") == "true";
    startTime = parseFloat(localStorage.getItem("startTime"));
    banditMarkers = parseInt(localStorage.getItem("banditsEncountered")) ?? 0;
    return true;
  }

  function saveState() {
    localStorage.setItem("playerFinished", JSON.stringify(playerFinished));
    localStorage.setItem("gameId", JSON.stringify(currentGameId));
    localStorage.setItem("shuffledLocations", JSON.stringify(shuffledLocations));
    localStorage.setItem("visitedLocations", JSON.stringify(visitedLocations));
    localStorage.setItem("gameState", gameState.toString());
    localStorage.setItem("money", money.toString());
    localStorage.setItem("foundDiamond", foundDiamond.toString());
    localStorage.setItem("startTime", startTime.toString());
    localStorage.setItem("banditsEncountered", banditMarkers.toString());
  }

  function resetState() {
    gameState = GAME_NOT_STARTED;
    money = 0;
    foundDiamond = false;
    foundTreasures = [];
    shuffledLocations = [];
    visitedLocations = [];
    playerFinished = false;
    for (var i in encounters) {
      shuffledLocations.push(i);
    }
    shuffle(shuffledLocations);

    startTime = new Date().getTime();
    banditMarkers = 0;
    saveState();
  }

  function resetGame() {
    resetState();
    updateGameState();
  }

  function updateGameState() {
    updateTreasureGrid();
    updateScore();
  }

  function renderQRCodeGameSeed(element, text, color) {
    trace("rendering");
    var url = "https://farbrormartin.github.io/QR-ai";
    var innerDiv = document.createElement("div");
    element.textContent = "";
    element.appendChild(innerDiv);
    innerDiv.classList.add("qr-code");
    var qrcode = new QRCode(innerDiv, {
      text: url + "?gameid=" + currentGameId + "&gameseed=" + text,
      width: Math.min(window.innerWidth * 0.6, 300),
      height: Math.min(window.innerWidth * 0.6, 300),
      colorDark: color,
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H
    });
    element.querySelector("img").classList.add("qr-code");
  }

  function toggleScanner() {
    setScannerState(videoContainer.classList.contains("hidden"));
  }

  function setScannerState(active) {
    if (active) {
      scanner.start();
      videoContainer.classList.remove("hidden");
      gameContainer.classList.add("hidden");
      scanButton.classList.add("active");

    } else {
      videoContainer.classList.add("hidden");
      gameContainer.classList.remove("hidden");
      scanButton.classList.remove("active");
      scanner.stop();
    }
  }

  function handleEncounterBing(location) {
    if (gameState == GAME_INITIALIZED) {
      showModal("Vänta på att ledaren startar spelet.");
    }
    else if (gameState == GAME_NOT_STARTED) {
      showModal("Börja med att skanna Start-koden.");
    }
    else if (gameState == GAME_FINISHED) {
      showModal("Spelet är slut, skanna Start-koden för att spela igen.");
    }
    else {
      visitedLocations.push(location);
      let shufffledLoc = shuffledLocations[location];
      let encounter = encounters[shufffledLoc];
      //isItemCollected = false;  
      trace(encounter);
      if (encounter == "bandit") {
        trace("bandit");
        handleBandit();
      }
      else if (encounters.includes(encounter)) {
        trace("treasure");
        handleTreasureFound(encounter);
      }
      else {
        showModal({
          message: "Det var ingenting här... :(",
          callback: function () {
            errorSound.play();
          }
        });
      }
    }
  }

  function handleBandit() {
    banditMarkers += 1;
    banditEncounterSound.play();
    let banditImg = document.createElement("img");
    banditImg.classList.add("bandit-marker");
    banditImg.src = banditImage;
    banditContainer.appendChild(banditImg);
    showModal({
      message: "Banditer!!",
      element: banditImg,
      buttonText: "Fly!!",
      callback: () => {
        let escapeMessage = ""
        if (banditMarkers == 3) {
          escapeMessage = "Banditerna tar alla dina pengar!";
          money = 0;
          banditCaughtSound.play();
        }
        else {
          escapeMessage = "Du lyckas fly!";
          banditEscapeSound.play();
        }
        showModal({
          message: escapeMessage,
          callback: () => {
            saveState();
            updateScore();
          }

        })

      }
    });

    // if (banditMarkers == 3) {
    //     money = 0;
    //     banditContainer.innerHTML = "";
    //     banditMarkers = 0;
    //     showModal({
    //         message: "Banditer! De stjäl alla dina pengar! :(",
    //         element: banditImg,
    //         callback: () => {
    //             money = 0;
    //             saveState();
    //             updateScore();
    //         }
    //     });
    // }
    // else{
    //     showModal({
    //         message: "Banditer! Du flyr i sista sekunden!",
    //         element: banditImg,
    //         callback: () => {
    //             saveState();
    //             updateScore();
    //         }
    //     });
    // }
  }

  function beginGameEndCountdown(){
    startCountdown(60);
  }

  function startCountdown(durationInSeconds) {
    let remainingTime = durationInSeconds;
    overlayText.classList.toggle("hidden", false);

    // Update the countdown every second
    const intervalId = setInterval(() => {
        // Calculate minutes and seconds from remainingTime
        const minutes = Math.floor(remainingTime / 60);
        const seconds = remainingTime % 60;

        // Display the result in the element with id="countdown"
        //overlayText.textContent = "Spelet avslutas om " +  `${minutes}:${seconds.toString().padStart(2, '0')}` + " sekunder.";
        overlayText.textContent = "Tid kvar " +  `${remainingTime.toString().padStart(2, '0')}` + " sekunder.";
        // Decrease the remaining time
        remainingTime--;

        if (gameState == GAME_FINISHED){
          clearInterval(intervalId);
          overlayText.textContent = "Väntar på ledaren...";
          overlayText.classList.toggle("hidden", true);
        }
        // When the countdown is over, clear the interval
        else if (remainingTime < 0) {
            clearInterval(intervalId);
            countdownElement.textContent = 'Spelet är slut.';
            if (gameState == GAME_IN_PROGRESS){
             sendGameOverEvent();
            }
        }
        
    }, 1000);
}

  function sendGameOverEvent(){
    console.log("Sending game over for "+ currentGameId);
    var eventsRef = database.ref('games/' + currentGameId + '/events');
    eventsRef.push({
      action: 'gameOver',
      byPlayer: playerId,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });
  }

  function handleTreasureFound(treasure) {
    let treasureData = treasures[treasure];
    let treasureValue = getValueForTreasure(treasure);
    let treasureImg = document.createElement("img");
    treasureImg.classList.add("treasure-image");
    treasureImg.src = treasureData.image;
    treasureData.sound.play();
    trace("handle treasure");
    if (treasure == "diamond"){

      sendFindTreasureEvent();
    }
    showModal({
      message: "Du hittade " + treasureData.name + "!",
      callback: () => {

        money += treasureValue;
        foundTreasures.push(treasure);
        saveState();
        updateScore();
        updateTreasureGrid();
      },
      element: treasureImg,
      secondMessage: treasureValue.toString() + "kr!"

    });
  }

  function updateTreasureGrid(){
    for (let i = 0; i < gemSlots.length; i++){
      if (foundTreasures.length > i){
        let treasureKey = foundTreasures[i];
        gemSlots[i].style.backgroundImage = "url('" + treasures[treasureKey].image + "')";
      }
      else{
        gemSlots[i].style.backgroundImage = "none";
      }
    }
    // for (let i in foundTreasures) {
    //   if (i < gemSlots.length) {
    //     gemSlots[i].style.backgroundImage = "url('" + gemsFound[i] + "')";
    //   }
    // }
  }

  function collectItem() {
    if (isItemCollected || foundItem === "none" || foundItem === "bandit") return;

    if (foundItem === "coins") {
      money += 1000;
      coinsSound.play();
    } else if (foundItem === "diamond") {
      money += 10000;
      foundDiamond = true;
      diamondSound.play();
    }

    colorBlock.style.backgroundImage = '';  // Clear image
    foundItem = "";  // Clear found item
    isItemCollected = true;

    saveState();
    updateScore();
  }

  function getValueForTreasure(treasure) {
    if (treasures.hasOwnProperty(treasure)) {
      return treasures[treasure].value * 1000;
    }
    else {
      return 0;
    }
  }

  function handleStartScanned() {
      const gameRef = database.ref('games/' + currentGameId);
      gameRef.once('value', snapshot => {
          const gameData = snapshot.val();

          if (gameData && gameData.in_progress) {
              // The game is in progress, so continue with this game
              console.log("Game in progress. Continuing game with ID: " + currentGameId);
              
              if (!playerFinished){
                finishTime = new Date().getTime() - startTime;
                var timeInSeconds = finishTime / 1000;
                var seconds = Math.floor(timeInSeconds % 60);
                var minutes = Math.floor(timeInSeconds / 60);
                playerFinished = true;
                saveState();
                sendGameOverEvent();
              }
              else{
                startNewGame();
              }
          }
          else {
              
              // No game found, or the game is finished, start a new game
              console.log("No game in progress found. Starting a new game.");
              startNewGame();
          }
      });
  

    // if (gameState === GAME_NOT_STARTED || gameState === GAME_FINISHED || !currentGameId ) {
    //   startNewGame();
    // }
    // else if (gameState === GAME_IN_PROGRESS) {

      
   // }
  }

  function handleSeedScanned(gameId, seed) {
    try {
      const parsedSeedData = JSON.parse(seed);
      
      showModal({
        message: "Spelinfo inläst. Tryck OK för att gå med i spelet.",
        callback: () => {
          joinGame(gameId, parsedSeedData);
          
        }
      });

    } catch (error) {
      showModal({
        message: "Något blev fel vid inläsningen av QR-koden. Prova att skanna igen, eller börja om med en ny kod."
      });
    }
  }

  function shuffle(array) {
    array.sort(() => Math.random() - 0.5);
  }

  function trace(message) {
    return;
    //     let el = document.createElement("div");
    //     el.textContent=message;
    //     document.querySelector("body").appendChild(el);
  }

  function adjustHeight() {
    const viewHeight = window.innerHeight;
    document.querySelector('.main-container').style.height = `${viewHeight}px`;
  }

  window.addEventListener('resize', adjustHeight);
  window.addEventListener('load', adjustHeight);



  // Your Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCKFBJPXhk_mFUBcCKWW4iz-ujwps_fIhM",
    authDomain: "martins-push-poc.firebaseapp.com",
    databaseURL: "https://martins-push-poc-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "martins-push-poc",
    storageBucket: "martins-push-poc.appspot.com",
    messagingSenderId: "701298343921",
    appId: "1:701298343921:web:cfed3991609cea60740e50"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  

  function joinGame(id, locations) {
    resetGame();
    currentGameId = id;
    shuffledLocations = locations;


    let playersRef = database.ref('games/' + currentGameId + '/players');
    playersRef.child(playerId).set(true);
    document.querySelector("#waiting-for-game-text").classList.toggle("hidden", false);
    listenForEvents();
  }

  function sendFindTreasureEvent() {
    if (!currentGameId) {
      console.log('findTreasure() without joining game first.');
      return;
    }

    var eventsRef = database.ref('games/' + currentGameId + '/events');
    eventsRef.push({
      action: 'treasureFound',
      byPlayer: playerId,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });
  }

  function deleteOldGames() {
    const gamesRef = database.ref('games');
    const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
    gamesRef.once('value').then(snapshot => {
      snapshot.forEach(gameSnapshot => {
        if (snapshot.val().timestamp < oneDayAgo) {
          gameSnapshot.ref.remove();
        }
      })


    });
  }

  function registerNewGame() {
    deleteOldGames();
    currentGameId = 'game_' + Math.random().toString(36).substr(2, 9);
    var gamesRef = database.ref('games/' + currentGameId);
    gamesRef.set({ in_progress: true });

    joinGame(currentGameId, shuffledLocations);
  }



  function listenForEvents() {
    var eventsRef = database.ref('games/' + currentGameId + '/events');
    eventsRef.on('child_added', (snapshot) => {
      
      const event = snapshot.val();
      console.log("Received event "+ event.action +" for "+ currentGameId);
      if (event.action === 'treasureFound'){
        if (event.byPlayer != playerId){
          showModal({message:"Diamanten är hittad, skynda dig till start!"});
        }
        beginGameEndCountdown();
        }
      else if(event.action ==="gameStarted"){
        gameState = GAME_IN_PROGRESS;
        whistleSound.play();
        startTime = new Date().getTime();
        overlayText.classList.toggle("hidden", true);
        saveState();
      }
      else if(event.action ==="gameOver"){
        console.log("Received game over.");
        if(gameState == GAME_IN_PROGRESS){
          finishGameSound.play();
          overlayText.classList.toggle("hidden", true)
          if (playerFinished){
            showModal({message:"Du hann tillbaka med " + money.toString() + " kr!"});

          }
          else{
            showModal({message:"Tyvärr hann du inte tillbaka i tid :("});
            money = 0;

          }
        }
        gameState = GAME_FINISHED;
        updateGameState();
        saveState();
      }
      

    });

    var playersRef = database.ref('games/' + currentGameId + '/players');
    playersRef.on('child_added', (snapshot) => {
      console.log("event playerId:"+snapshot.key +" playerId:"+playerId);
      if (snapshot.key !== playerId) {
        console.log("Displaying notification");
        //displayNotification('Player ' + snapshot.key + ' joined the game');
        showPopup("Spelare "+ snapshot.key + " joinade!");
      }
      //updatePlayerList();
    }
    );
  }

  function displayNotification(messageText) {
    showModal({
      message: messageText
    });
  }

  function showPopup(messageText) {
    let popup = document.createElement("div");
    popup.classList.add("timed-popup");
    popup.textContent=messageText;
    let body = document.querySelector("body");
    body.appendChild(popup)
    setTimeout(()=> body.removeChild(popup), 3000);
  }
  if (window.location.hostname == "localhost") {
     testMode = true;
     
  }
  testMode = true;
  document.querySelector("button").addEventListener("click", () => clickSound.play());
  document.querySelector(".frame").addEventListener("click", () => document.querySelector(".top-gem").classList.toggle("hidden"));
  // Initialization
  trace("initializing");
  loadState();
  scanQRCode(new URLSearchParams(window.location.search));
  updateGameState();
  console.log("Gamestate: " + gameState.toString());

  // for (let i= 1; i<10; i++){
  //   setTimeout(() => showPopup("Hello "+i.toString()), 1000*i);
  // }
  //}
  // catch (error){
  //     let el = document.createElement("div");
  //     el.textContent=error;
  //     document.querySelector("body").appendChild(el);
  // }


</script>